# 堡垒纪元 更新日志 (Changelog)

---

## v0.3.1 — Bug 修复与交互优化 (2026-02-15)

### Bug 修复

- **兵营无法建造**：`add_exp()` 只更新 `total_exp` 而未同步 `resources["exp"]`，导致建筑系统检测经验值始终为 0
- **兵营按钮文案错误**：HUD 底部按钮显示"兵营(30金)"，改为"兵营(30经验)"
- **资源不足提示硬编码**：提示固定为"金币不足！"，现根据实际资源类型动态显示（金币/经验/水晶）
- **NPC 不刷新**：BuildingManager 为 Autoload 单例，`npc_spawned` 字典跨局残留，导致新局中 3 箭塔不触发弓箭手生成；新增 `reset()` 方法并在 `_setup_game()` 中调用
- **波次不推进**：WaveSpawner 的 `active_enemies` 计数器在 `load_stage()` 时未重置，导致杀光敌人后无法进入下一波；增加计数器重置和存活敌人实际校验兜底

### 交互优化

- **出征 UI 重构**：从右侧 35% 面板改为底部条布局，减少对战斗画面的遮挡
  - 副本选择 / 结算 → 居中弹窗
  - 进度、计时、支援按钮 → 底部 40px 条
- **出征期间隐藏建筑按钮**：避免出征战斗中误触建造
- **移除重复 UI**：ExpeditionBattle 不再创建独立的标题/阶段/计时标签，统一由 ExpeditionPanel 底部条显示

---

## v0.3.0 — 大型玩法更新 (2026-02-15)

### 新增英雄

- **辉石法师** (`crystal_mage`) — 技能爆发型法师
  - 主动技能：棱镜折射（弹射多目标）、宝石牢笼（范围困敌）
  - 终极技能：七彩棱镜（全屏光柱）
  - 被动：辉石共鸣（技能命中后下次普攻伤害 +60%）
- **重力法师** (`gravity_mage`) — 控制型坦克
  - 主动技能：重力井（吸引敌人聚集）、重力翻转（击飞范围敌人）
  - 终极技能：奇点坍缩（大范围持续伤害）
  - 被动：质量坍缩（周围敌人越多，防御越高，最高 +50%）

### 卡牌系统扩展（15 → 25 张）

- 新增 **装备卡**（5 张）：烈焰之剑、寒霜盾牌、疾风之靴等，带槽位标识（武器/护甲/饰品）
- 新增英雄专属强化卡：辉石法师增强、重力法师增强
- 卡牌 UI：悬停 0.5 秒后显示效果预览面板（属性加成用绿色，资源用金色）

### 建筑系统

- 新增 **铸造所** (`tech_forge`) — 全队属性提升建筑
- 建筑升级系统：多等级数据驱动，升级面板 UI

### 波次系统重构

- 扩展为 **3 阶段 / 12 波**：教学(2波) → 中期(5波) → 后期(5波)
- 每阶段独立英雄伤害系数（0.6 / 0.8 / 1.0）
- 敌人 HP 随波次倍率递增
- EnemyPool 对象池预热（`prewarm_for_stage`）

### 远征系统

- **三段式战斗结构**：小怪阶段 → 精英阶段 → 城堡/BOSS 阶段
- 3 个远征副本：骷髅墓穴、兽人要塞、暗影神殿
- ExpeditionBattle 自动战斗 + ExpeditionManager 流程管理
- 远征 UI 面板（选择副本、阶段进度、支援按钮）

### 架构重构

- **GameSession 拆分**：从 738 行精简到 262 行协调层
  - `HeroController` — 英雄生成与管理
  - `InputController` — 多玩家输入分发（P1: WASD+QER, P2: 方向键+JKL）
  - `NPCController` — NPC 自动生成与管理
  - `UIController` — 全部 UI 面板协调

### 战斗反馈

- **帧冻结**（Hitstop）：普通命中 2 帧，暴击 5 帧，`Engine.time_scale` 实现
- **击退视觉**：普通 5px，暴击 10px，带随机角度偏移
- **连杀系统**：5/10/20/50/100 连杀屏幕提示（"连杀 x5" → "神一般的割草!"）
- **死亡粒子爆散**：GPUParticles2D 一次性爆发
- **屏幕震动改进**：指数衰减曲线替代均匀震动

### HUD 重构

- **三级信息层级**：
  - Tier 1（始终可见）：堡垒 HP、当前波次
  - Tier 2（常驻低调）：金币/水晶、技能冷却、城镇等级
  - Tier 3（动态显隐）：击杀数、经验进度（战斗激烈时自动隐藏）
- **低血量警告**：堡垒 HP < 30% 时红色脉冲遮罩
- **HP 条颜色过渡**：绿(>60%) → 黄(>30%) → 红(<30%)
- **波次清除反馈**："Wave Clear!" 缩放弹出动画

### 英雄/NPC 生存系统

- **浮动血条**：英雄（24×3px）和 NPC（20×2px）头顶实时 HP 显示
- **英雄复活**：阵亡后 10 秒自动复活（扣堡垒 10% HP 作惩罚）
- **NPC 复活**：战斗中阵亡本波不复活
- **新波次重置**：所有己方单位（英雄 + NPC）满血复活
- **资源不足提示**：建造资源不够时屏幕显示红色提示

### Bug 修复

- 修复 `WaveSpawner._spawn_enemy()` 参数数量不匹配（3 vs 2）
- 修复 `InputController` 访问已释放英雄实例导致崩溃
- 修复建筑快捷键 `is_key_pressed` 每帧触发改为 `is_action_just_pressed`
- NPC 死亡不再 `queue_free`，改为淡出等待复活

---

## v0.2.3 — 单人模式打磨 (2026-02-14)

### 关键更新

- **暂停菜单**：ESC 键暂停/恢复游戏
- **新手引导提示**：教学阶段居中大字引导（"WASD 移动英雄，消灭所有史莱姆！"）
- **统一伤害系统**：DamageSystem Autoload 统一管理伤害计算、飘字、视觉反馈
- **被动技能实现**：白狼骑士嗜血本能（低血 +40% 攻击、击杀回血）、流星法师星火燎原（灼烧 DOT）
- **数值调优**：全局 balance_multipliers（英雄/塔/NPC 伤害倍率）
- **攻击视觉特效**：扇形斩击弧线、AOE 落点圆圈、单体攻击射线

---

## v0.2.1 — 远征与 NPC (2026-02-14)

### 关键更新

- **远征战斗系统**：NPC 单位自动出征副本
- **NPC 系统**：建筑满 3 自动生成对应 NPC（弓箭手/骑士/矿工）
- **局外成长**（Meta Progression）：跨局永久升级（攻击/HP/防御 +%）
- **存档系统**：SaveManager 自动保存/加载进度

---

## v0.1.0 — 可玩原型 (2026-02-13)

### 关键模块

- **Phase 1 核心战斗**：英雄移动、自动攻击、敌人 AI 寻路、共享 HP 堡垒
- **Phase 2 建筑运营**：箭塔/金矿/兵营放置、网格吸附、资源管理
- **Phase 3 Roguelike 卡牌**：波次结算后 3 选 1 卡牌、属性/资源/技能强化
- **Phase 4 流程串联**：PhaseManager 状态机完整游戏循环（教学→防守→结算→建造→防守）
- **对象池**：EnemyPool 敌人回收复用
- **战斗闪白**：ShaderMaterial 闪白着色器（内嵌 GLSL）
- **伤害飘字**：Tween 动画向上飘 + 淡出，暴击黄色大字
