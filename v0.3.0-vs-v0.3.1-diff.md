# 堡垒纪元 v0.3.0（代码实际）vs v0.3.1（设计文档）差异清单

> 供团队 Discord 确认，逐项标注当前状态和需要改动的内容。

---

## 一、整体架构

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 游戏目标 | 存活 3 阶段 12 波即胜利 | 击杀魔王城堡 BOSS 才算胜利 | **需改** |
| 整体流程 | 教学→防守→卡牌→建造→防守→远征（循环） | 防守(5波)→出征→防守→出征→最终出征击杀魔王 | **需改** |
| 玩家模式 | 单人（预留 P2 按键框架但未实际使用） | 纯单人 | 基本一致，移除 P2 框架 |
| 出征定位 | 可选副本奖励（3 个独立地下城） | 主线叙事（攻打魔王城堡，多次出征累计削血） | **需重做** |

---

## 二、建筑系统

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 建筑种类 | 4 种（箭塔/金矿/兵营/铸造所） | 3 种（箭塔/兵营/金矿） | 移除铸造所 |
| 放置方式 | 16×16 网格，检查格子是否占用 | 方格子自由放置，无路径概念 | 基本一致 |
| 建筑可被攻击 | **未实现**，建筑无 HP | 敌人会攻击挡路建筑，打掉后继续走 | **需新增** |
| 建筑血条 | 无 | 被攻击时显示血条 | **需新增** |
| 建筑被拆毁 | 无 | 爆炸特效 + 碎片飞散，防线出现缺口 | **需新增** |
| 箭塔功能 | 远程攻击，3 级升级（dmg 16/30/50） | 自动锁定最近敌人，发射箭矢 | 基本一致 |
| 金矿功能 | 10 秒产 5/12/15 金，击杀加成 | 每 5 秒 +5 金币 | 数值需调整 |
| 兵营功能 | 提供全队攻击/HP/护甲加成 | 建造后弹出英雄选择，英雄从兵营走出 | **需重做** |
| 建筑解锁时机 | 开局全部可用 | 箭塔开局可用；兵营+金矿第 3 波后弹出选择 | **需改** |
| 初始可见建筑 | 底栏 3 个按钮 | 右下角 3 个建筑图标 | UI 调整 |

---

## 三、英雄系统

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 英雄数量 | 4 个（白狼/流星/辉石/重力） | 3 选 1（白狼/辉石/重力） | 移除流星法师 |
| 出场时机 | 开局自动生成 wolf_knight | 第 3 波后建兵营才解锁，弹卡牌选择 | **需改** |
| 操控方式 | **玩家 WASD 直接操控移动** | **英雄自动战斗**，玩家不操控 | **核心改动** |
| 技能释放 | 玩家按 Q/E/R 手动释放 | 英雄自动释放技能 | **需改** |
| 等级系统 | 英雄无独立等级，依赖卡牌强化 | **继承城镇等级**（城镇升级=英雄升级） | **需新增** |
| 属性成长 | 仅通过卡牌/装备/被动强化 | 城镇升级时属性自动成长 | **需新增** |
| 技能获取 | 开局自带全部技能（2主动+1终极+1被动） | 城镇升级时弹卡牌选技能 | **需改** |
| 英雄死亡 | 10 秒复活，扣堡垒 10% HP | 10 秒原地复活，满状态 | 去掉惩罚或保留待定 |
| 英雄血条 | 头顶浮动血条（24×3px） | 有血条 | 一致 |

---

## 四、敌人系统

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 敌人种类 | 7 种（slime/goblin/skeleton/ghost/zombie/orc_elite/demon_boss） | 4 种（史莱姆/哥布林/兽人战士/兽人酋长Boss） | 精简，移除 skeleton/ghost/zombie |
| 敌人到达城堡 | 扣 1 点 HP + 敌人立即 die() | 接触城堡**瞬间消失**扣血，城堡闪红 | 基本一致 |
| 敌人攻击建筑 | **未实现** | 精英/Boss 会停下来攻击挡路建筑 | **需新增** |
| 精英敌人 | orc_elite（HP 500, 75%/50%/25% 狂暴加攻速） | 兽人战士（大体型，红色标记，攻击建筑） | 需调整行为 |
| Boss 敌人 | demon_boss（HP 3000, 60% 二阶段） | 兽人酋长（Boss标记，"战争怒吼"buff 周围敌人） | 需调整技能 |
| 敌人血条 | 无头顶血条 | 头顶绿色血条 | **需新增** |
| 死亡表现 | 粒子爆散 + 闪白 | 死亡动画（如史莱姆融化）+ 掉落金币 | 需加金币掉落物 |
| 金币掉落 | 击杀自动加到账户 | **原地掉落金币**，玩家手动点击拾取 | **核心改动** |

---

## 五、波次设计

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 总波次数 | 3 阶段 12 波（2+5+5） | 1 阶段 5 波 | **需精简** |
| 第 1 波 | 10 只 slime | 5 只史莱姆（教学波） | 数量调整 |
| 第 2 波 | 20 只 goblin | 10 只哥布林（分 2 队） | 数量+行为调整 |
| 第 3 波 | 25 只 skeleton + 8 只 ghost（阶段 2） | 30 只哥布林 + 1 只兽人战士（精英首次出现） | **需重写** |
| 第 4 波 | 多种混合 + 2 只 orc_elite | 50 只哥布林 + 3 只兽人战士（英雄首秀+技能解锁） | **需重写** |
| 第 5 波 | demon_boss + 持续刷骷髅 | 大量哥布林 + 多只兽人 + 兽人酋长 Boss | **需重写** |
| 叙事节奏 | 纯数值递增 | 教学→压力→英雄登场→爽感爆发→Boss | **需重写** |
| 波次间隔 | 7 秒准备 + 3 秒倒计时 | 10 秒倒计时 | 数值调整 |

---

## 六、经济系统

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 初始金币 | 100 | 10 | **需改** |
| 金币获取方式 | 击杀自动加入账户 | 击杀后**原地掉落金币**，玩家**手动点击拾取** | **核心改动** |
| 金矿产出 | 10 秒 +5 金（Lv.1） | 5 秒 +5 金 | 数值调整 |
| 资源种类 | 金币 + 水晶 + 徽章 + 经验 | 金币 + 经验（简化） | 移除水晶/徽章 |
| 建筑价格 | 箭塔 50金 / 兵营 30经验 / 金矿 50金 | 待定（初始 10 金，箭塔要能买得起） | **需调整** |

---

## 七、出征系统

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 定位 | 可选的奖励副本（骷髅墓穴/兽人要塞/暗影神殿） | **主线进攻**：攻打魔王城堡 | **需重做** |
| 触发时机 | 阶段全部波次通关后可选 | 每个防守阶段结束后自动进入 | 需改为自动 |
| 出征内容 | 3 阶段（小怪→精英→城堡/Boss），NPC 自动战斗 | 英雄自动前进，守卫→城堡→最终 Boss | **需重做** |
| 出征次数 | 每阶段 1 次可选 | 多次出征累计削血（首次被秒、二次能打、最终击杀） | **核心改动** |
| 首次体验 | 正常战斗 | **设计为被秒杀**（制造不甘心感） | **需新增** |
| 魔王城堡 HP | 无（每次独立副本） | 跨出征累计，多次出征逐步削弱 | **需新增** |
| 出征单位 | NPC 单位出征 | 英雄出征 | 需改为英雄 |
| 玩家操控 | 无（自动战斗 + 支援按钮） | 无（英雄自动前进+战斗） | 基本一致 |

---

## 八、卡牌系统

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 卡牌总数 | 22 张（属性5+技能7+资源5+装备5） | 技能卡（城镇升级时弹出选择） | **大幅精简** |
| 触发时机 | 每波结算后 3 选 1 | 城镇升级时弹出技能卡选择 | **需改** |
| 卡牌类型 | 属性/技能/资源/装备 4 类 | 仅技能卡 | 移除属性/资源/装备卡 |
| 装备系统 | 5 张装备卡（武器/护甲/饰品） | 无 | 移除 |

---

## 九、UI 与反馈

| 项目 | v0.3.0 代码实际 | v0.3.1 文档要求 | 差异 |
|------|---------------|---------------|------|
| 顶部信息 | 堡垒 HP + 波次 + 金币/水晶 | "第X阶段 第X回合" + 城堡血条 + 金币 | 格式调整 |
| 建筑栏位置 | 底部 HBoxContainer | 右下角建筑图标 | 位置调整 |
| 波次结算 | "Wave Clear!" 弹出 | 详细结算（击杀数、金币、经验、属性变化） | **需增强** |
| 城镇升级提示 | "Town Level Up! Lv.X" 淡出 | 金色大字 + 属性变化详情 + 技能卡选择 | **需增强** |
| 结算画面 | 简单版（击杀/金币/水晶/波次） | 详细版（时长/难度/评级/永恒币/成就） | **需增强** |
| 叙事文字 | 仅新手引导 | 各场景有剧情提示（"防线被突破！" "你的英雄战死沙场..."） | **需新增** |
| 出征被秒杀 | 无 | 屏幕变暗 + 悲壮文字 + 音乐 | **需新增** |

---

## 十、已一致 / 可复用的部分

以下模块 v0.3.0 已实现，v0.3.1 可直接复用或微调：

| 模块 | 说明 |
|------|------|
| DamageSystem | 伤害公式 max(ATK-DEF,1) + 暴击 ×2，飘字系统 |
| CombatFeedback | 帧冻结、击退、连杀、死亡粒子、屏幕震动、闪白 |
| StatsComponent | 属性组件 + FLAT/PERCENT 修改器系统 |
| 复活机制 | 英雄 10 秒复活 + NPC 新波次复活 |
| 英雄浮动血条 | 头顶 HP 条 + 颜色变化 |
| NPC 系统 | NPCUnit 巡逻 AI + AutoAttack（需调整为不从兵营生成） |
| 建筑放置 | 网格吸附 + 预览虚影 + 占位检测 |
| 资源不足提示 | 屏幕红色文字提示 |
| 低血量警告 | 堡垒 HP<30% 红色脉冲遮罩 |
| SaveManager | 存档读写 |
| 对象池 | EnemyPool 预热 + 回收 |

---

## 总结：需要改动的优先级

### P0 核心改动（改变玩法体验）
1. **英雄自动战斗**（移除 WASD 操控，英雄 AI 自动攻击+释放技能）
2. **金币手动拾取**（击杀掉落地面物品，玩家点击拾取）
3. **建筑可被攻击/拆毁**（建筑加 HP，敌人攻击挡路建筑）
4. **出征系统重做**（主线攻打魔王城堡，累计削血，首次被秒杀设计）

### P1 流程重构
5. 波次精简为 5 波 + 叙事节奏重写
6. 英雄第 3 波后通过兵营解锁（非开局自带）
7. 卡牌改为城镇升级时选技能
8. 初始金币 100→10，经济重新平衡

### P2 内容调整
9. 敌人精简为 4 种 + 加头顶血条
10. 移除流星法师、铸造所、水晶/徽章资源
11. 详细结算画面（评级/成就/永恒币）
12. 叙事文字和场景提示
